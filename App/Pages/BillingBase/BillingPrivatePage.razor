@page "/billing/private"

<h3>Privat fakturaunderlag</h3>

<PageInfo Content="Fakturaunderlag för privata kunder, ifall du har ändrat på kunduppgifter, eller tagit bort kunder, kan du uppdatera hela underlaget med knappen 'Läs om innehåll' längst ner. Sparat innehåll kommer inte skadas av detta." />
@if (BillingBase is null)
{
    <span>Hittade inget underlag.</span>
}
else
{
    <EditForm Model="@BillingBase.Items" OnValidSubmit="@(() => TrySaveAsync())">
        <table class="table">
            <thead>
                <tr>
                    <th>Namn</th>
                    <th>Veckor</th>
                    <th>Antal gånger</th>
                    <th>Timmar per gång</th>
                    <th>Totala timmar</th>
                    <th>Timpris</th>
                    <th>Ex. moms</th>
                    <th>Ink. moms</th>
                    <th>Efter rut</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in BillingBase.Items)
                {
                    <tr>
                        <td>@($"{item.FirstName} {item.LastName}")</td>
                        <td><InputText @bind-Value="@item.WeeksAttended" class="form-control" id="@($"WeeksAttended-{item.Id}")" placeholder="Veckor" /></td>
                        <td><InputText @bind-Value="@item.AmountOccassions" class="form-control" id="@($"AmountOccassions-{item.Id}")" placeholder="" /></td>
                        <td><InputText @bind-Value="@item.HoursPerVisit" class="form-control" id="@($"HoursPerVisit-{item.Id}")" placeholder="Timmar per gång" /></td>
                        <td><InputText @bind-Value="@item.TotalHours" @onblur="(() => UpdateValues(item))" class="form-control" id="@($"TotalHours-{item.Id}")" placeholder="" /></td>
                        <td>@item.PricePerHour</td>
                        <td>@item.ExVAT</td>
                        <td>@item.IncVAT</td>
                        <td>@item.AfterRUT</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary">Spara förändringar <i class="oi oi-check"></i></button>
            <a role="button" href="" @onclick:preventDefault class="btn btn-primary" @onclick="(() => SyncBillingBaseAsync())">Läs om innehåll <i class="oi oi-action-redo"></i></a>
            <a role="button" href="" @onclick:preventDefault class="btn btn-success" @onclick="(() => TryDownloadExcelAsync())">Exportera Excel <i class="oi oi-data-transfer-download"></i></a>
        </div>
    </EditForm>
}

@code {
    [Inject] IPrivateBillingService BillingService { get; set; }
    [Inject] IToastService ToastService { get; set; }
    [Inject] NavigationManager Nav { get; set; }

    private PrivateBillingInfo BillingBase;
    private int Id;

    protected async override Task OnInitializedAsync()
    {
        var result = await BillingService.GetCurrentBillingAsync();
        Id = result.Entity.Id;
        BillingBase = result.Entity;
    }

    private void UpdateValues(PrivateBillingItemInfo item)
    {
        if (!double.TryParse(item.TotalHours, out double totalHours)) return;
        item.ExVAT = totalHours * item.PricePerHour;
        item.IncVAT = item.ExVAT * 1.25;
        item.AfterRUT = item.IncVAT / 2;
        StateHasChanged();
    }

    private bool ParseSendData()
    {
        foreach (var item in BillingBase.Items)
        {
            if (!double.TryParse(item.TotalHours, out double _) && !string.IsNullOrWhiteSpace(item.TotalHours))
            {
                ToastService.ShowWarning("\"Totala timmar\" på ett eller flera fält är fel format, måste anges numeriskt", "Oj");
                return false;
            }
            if (!double.TryParse(item.AmountOccassions, out double _) && !string.IsNullOrWhiteSpace(item.AmountOccassions))
            {
                ToastService.ShowWarning("\"Antal gånger\" på ett eller flera fält är fel format, måste anges numeriskt", "Oj");
                return false;
            }
        }
        return true;
    }

    private async Task<bool> TrySaveAsync(bool showToast = true)
    {
        if (!ParseSendData()) return false;
        var result = await BillingService.UpdateBillingAsync(BillingBase);
        if (!result.Success)
        {
            if (showToast) ToastService.ShowWarning("Lyckades inte spara", "Ajdå");
            return false;
        }
        if (showToast) ToastService.ShowSuccess("Fakturaunderlaget sparades", "Perfekt");
        BillingBase = result.Entity;
        StateHasChanged();
        return true;
    }

    private async void SyncBillingBaseAsync()
    {
        var result = await BillingService.SyncBillingItemsAsync(Id);
        if (result.Success)
        {
            ToastService.ShowInfo("Fakturaunderlaget uppdaterades", "Info");
            BillingBase = result.Entity;
        }
        else
            ToastService.ShowWarning("Lyckades inte uppdatera", "Ajdå");
        StateHasChanged();
    }

    private async void TryDownloadExcelAsync()
    {
        if (!await TrySaveAsync(false))
        {
            ToastService.ShowWarning("Kunde inte spara dokumentet innan nedladdning", "Ajdå");
            return;
        }
        var result = await BillingService.GetExcelSheetAsync(Id);
        if (!result.Success)
        {
            ToastService.ShowInfo("Kunde inte exportera excelfil", "Något gick snett");
            return;
        }

        ToastService.ShowInfo(result.Entity.FileName, "Underlag redo");
    }
}
