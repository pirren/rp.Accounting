@page "/billing/private"

<h3>Privat fakturaunderlag</h3>

<PageInfo Content="Fakturaunderlag för privata kunder, ifall du har ändrat på kunduppgifter, eller tagit bort kunder, kan du uppdatera hela underlaget med knappen 'Läs om innehåll' längst ner. Sparat innehåll kommer inte skadas av detta." />
@if (BillingBase == null)
{
    <span>Hittade inget underlag.</span>
}
else
{
    <EditForm Model="@BillingBase.Items" OnValidSubmit="@TrySend">
        <table class="table">
            <thead>
                <tr>
                    <th>Namn</th>
                    <th>Veckor</th>
                    <th>Antal gånger</th>
                    <th>Timmar per gång</th>
                    <th>Totala timmar</th>
                    <th>Timpris</th>
                    <th>Ex. moms</th>
                    <th>Ink. moms</th>
                    <th>Efter rut</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in BillingBase.Items)
                {
                    <tr>
                        <td>@($"{item.FirstName} {item.LastName}")</td>
                        <td><InputText @bind-Value="@item.WeeksAttended" class="form-control" id="@($"WeeksAttended-{item.Id}")" placeholder="Veckor" /></td>
                        <td><InputText @bind-Value="@item.AmountOccassions" class="form-control" id="@($"AmountOccassions-{item.Id}")" placeholder="" /></td>
                        <td><InputText @bind-Value="@item.HoursPerVisit" class="form-control" id="@($"HoursPerVisit-{item.Id}")" placeholder="Timmar per gång" /></td>
                        <td><InputText @bind-Value="@item.TotalHours" @onblur="(() => UpdateValues(item))" class="form-control" id="@($"TotalHours-{item.Id}")" placeholder="" /></td>
                        <td>@item.PricePerHour</td>
                        <td>@item.ExVAT</td>
                        <td>@item.IncVAT</td>
                        <td>@item.AfterRUT</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="form-group mt-3">
            <button type="submit" class="btn btn-primary">Spara förändringar <i class="oi oi-check"></i></button>
            <button class="btn btn-primary" @onclick="(() => SyncBillingBaseAsync())">Läs om innehåll <i class="oi oi-action-redo"></i></button>
            <button class="btn btn-success">Ladda ner Excel <i class="oi oi-data-transfer-download"></i></button>
        </div>
    </EditForm>
}

@code {
    [Inject] IPrivateBillingBaseService BillingBaseService { get; set; }
    [Inject] IToastService ToastService { get; set; }

    private PrivateBillingBaseInfo BillingBase;
    private int Id;

    protected async override Task OnInitializedAsync()
    {
        var result = await BillingBaseService.GetCurrentBillingBaseAsync();
        Id = result.Entity.Id;
        BillingBase = result.Entity;
    }

    private void UpdateValues(PrivateBillingBaseItemInfo item)
    {
        if (!double.TryParse(item.TotalHours, out double totalHours)) return;
        item.ExVAT = totalHours * item.PricePerHour;
        item.IncVAT = item.ExVAT * 1.25;
        item.AfterRUT = item.IncVAT / 2;
        StateHasChanged();
    }

    private async void TrySend()
    {
        foreach (var item in BillingBase.Items)
        {
            if (!double.TryParse(item.TotalHours, out double _) && !string.IsNullOrWhiteSpace(item.TotalHours))
            {
                ToastService.ShowWarning("\"Totala timmar\" på ett eller flera fält är fel format, måste anges numeriskt", "Oj");
                return;
            }
            if (!double.TryParse(item.AmountOccassions, out double _) && !string.IsNullOrWhiteSpace(item.AmountOccassions))
            {
                ToastService.ShowWarning("\"Antal gånger\" på ett eller flera fält är fel format, måste anges numeriskt", "Oj");
                return;
            }
        }
        var result = await BillingBaseService.UpdateBillingBaseAsync(BillingBase);
        if (!result.Success)
        {
            ToastService.ShowWarning("Lyckades inte spara", "Ajdå");
            return;
        }
        ToastService.ShowSuccess("Fakturaunderlaget sparades", "Perfekt");
        BillingBase = result.Entity;
        StateHasChanged();
    }

    private async void SyncBillingBaseAsync()
    {
        var result = await BillingBaseService.SyncBillingBaseItemsAsync(Id);
        if (result.Success)
        {
            ToastService.ShowInfo("Fakturaunderlaget uppdaterades", "Info");
            BillingBase = result.Entity;
        }
        else
            ToastService.ShowWarning("Lyckades inte uppdatera", "Ajdå");
        StateHasChanged();
    }
}
